<html>
<head>
</head>
<body>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
	<div id="roomNum" style="display:none;">
		Tell them to join room number: <span id="num"></span>
	</div>
	<div>Your Score:</div>
	<div id="life" style="display:none;">100</div>
	<div>Other Score:</div>
	<div id="otherlife" style="display:none;">100</div>
	<div>Your Attack Count:</div>
	<div id="attacks" style="display:none;">0</div>
	<div>Their Attack Count:</div>
	<div id="defends" style="display:none;">0</div>
	<div>Stage:</div>
	<div id="startAttack" style="display:none;">Begin Attack</div>
	<div id="defend" style="display:none;">Defend</div>
	<div id="finishAttack" style="display:none;">Finished Attacking</div>
	<div>Instructions:</div>
	<div>To attack, use left, right, or up keys</div>
	<div>To defend, use left, right, or up keys to match what the attack was</div>
	<div id="audios" style="display:none;">
	<audio id="left" controls src="left.wav"></audio>
	<audio id="center" controls src="center.wav"></audio>
	<audio id="right" controls src="right.wav"></audio>
	</div>
	<script type="text/javascript" src="https://cdn.firebase.com/v0/firebase.js"></script>
	<script type="text/javascript">
		var gameID=getURLParameter("room");
		if(gameID=="null") {
			gameID=Math.floor(Math.random()*1000000);
			$("#num").text(gameID);
			$("#roomNum").show();
		}
		var playerID=1;
		var otherID=2;
		var gameStarted=false;
		var left=document.getElementById("left");
		var center=document.getElementById("center");
		var right=document.getElementById("right");
		var game = new Firebase('https://swordgame.firebaseio.com/'+gameID+'/');
		var canAttack=true;
		var currentAttacks=[];
		var currentTimeouts=[];
		game.child('players').child(playerID).onDisconnect().set("offline");
		var func = function(isOnline) {
			if (isOnline.val()) {
				playerID=2;
				otherID=1;
				game.child('players').off('value', func);
				game.child('players').child(playerID).set("online");
				beginGame();
			} else {
				game.child('players').off('value', func);
				game.child('players').child(playerID).set("online");
				$("#num").text(gameID);
				$("#roomNum").show();
				game.child('players').on('child_added',function(data) {
					if(data.name()==2) {
						beginGame();
					}
				});
			}
			if(isOnline.child("1").val()=="offline"||isOnline.child("2").val()=="offline") {
				window.location="index.html";
			}
		}
		game.child('players').on('value', func);
		game.child('players').on('child_changed',function(data) {
			if(data.val()=="offline") {
				window.location='index.html';
			}
		});
		game.child("scores").on('child_changed',function(data) {
			if(data.name()==otherID) {
				$("#otherlife").text(data.val());
			}
		});
		game.on('child_changed',function(data) {
			if(data.name()=="attacking") {
				currentAttacks=[];
				currentTimeouts=[];
				$("#attacks").text("0");
				$("#defends").text("0");
				if(data.val()==playerID) {
					canAttack=true;
					$("#startAttack").show();
					$("#finishAttack").hide();
					$("#defend").hide();
				} else {
					canAttack=false;
					$("#startAttack").hide();
					$("#finishAttack").hide();
					$("#defend").show();
				}
			}
		});
		$('body').keydown(function(event) {
			if(event.which==37) {
				lPress();
			} else if(event.which==38) {
				cPress();
			} else if(event.which==39){
				rPress();
			}
		});
		function beginGame() {
			$("#roomNum").hide();
			$("#life").show();
			$("#attacks").show();
			$("#defends").show();
			game.child("attacking").set(0);
			game.child("attacking").set(1);
			game.child("scores").child(1).set(100);
			game.child("scores").child(2).set(100);
			gameStarted=true;
			game.child(playerID).on('child_added', function (snapshot) {
				var message = snapshot.val().move;
				if(message=="l") {
					lAttack();
				} else if(message=="c") {
					cAttack();
				} else if(message=="r") {
					rAttack();
				}
			});
		}
		function block(which) {
			for(var i=0;i<currentAttacks.length;i++) {
				if(currentAttacks[i]==which) {
					currentAttacks[i]='done';
					clearTimeout(currentTimeouts[i]);
					return;
				}
			}
			loseLife();
		}
		function attacked() {
			if(canAttack) {
				$("#attacks").text(parseInt($("#attacks").text())+1);
				if(parseInt($("#attacks").text())>=10) {
					$("#startAttack").hide();
					$("#finishAttack").show();
					canAttack=false;
					setTimeout(function(){
						game.child("attacking").set(otherID);
					},1000);
				}
			}
		}
		function beenAttacked(which) {
			if(!canAttack) {
				var curr=parseInt($("#defends").text());
				currentAttacks.push(which);
				currentTimeouts.push(setTimeout(function(){
					loseLife();
				},1000));
				$("#defends").text(curr+1);
			}
		}
		function loseLife() {
			$("#life").text(parseInt($("#life").text())-1);
			game.child("scores").child(playerID).set(parseInt($("#life").text()));
		}
		function lPress() {
			if(!gameStarted) return;
			if(canAttack) {
				l();
				attacked();
				game.child(otherID).push({move: 'r'});
			} else {
				block('l');
			}
		}
		function cPress() {
			if(!gameStarted) return;
			if(canAttack) {
				c();
				attacked();
				game.child(otherID).push({move: 'c'});
			} else {
				block('c');
			}
		}
		function rPress() {
			if(!gameStarted) return;
			if(canAttack) {
				r();
				attacked();
				game.child(otherID).push({move: 'l'});
			} else {
				block('r');
			}
		}
		function lAttack() {
			if(!gameStarted) return;
			if(canAttack) return;
			l();
			beenAttacked('l');
		}
		function cAttack() {
			if(!gameStarted) return;
			if(canAttack) return;
			c();
			beenAttacked('c');
		}
		function rAttack() {
			if(!gameStarted) return;
			if(canAttack) return;
			r();
			beenAttacked('r');
		}
		function l() {
			left.currentTime=0;
			left.play();
		}
		function c() {
			center.currentTime=0;
			center.play();
		}
		function r() {
			right.currentTime=0;
			right.play();
		}
		function getURLParameter(name) {
		    return decodeURI(
		        (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
		    );
		}
	</script>
</body>
</html>